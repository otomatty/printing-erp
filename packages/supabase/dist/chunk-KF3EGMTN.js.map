{"version":3,"sources":["../src/check-requires-mfa.ts"],"names":[],"mappings":";;;AAuDA,IAAM,iBAAoB,GAAA,MAAA;AAQ1B,eAAsB,uCACpB,MACA,EAAA;AAGA,EAAI,IAAA,2BAAA,IAA+B,OAAO,IAAM,EAAA;AAC9C,IAAA,MAAA,CAAO,KAAK,yBAA4B,GAAA,IAAA;AAAA;AAG1C,EAAA,MAAM,cAAiB,GAAA,MAAM,MAAO,CAAA,IAAA,CAAK,IAAI,8BAA+B,EAAA;AAE5E,EAAI,IAAA,2BAAA,IAA+B,OAAO,IAAM,EAAA;AAC9C,IAAA,MAAA,CAAO,KAAK,yBAA4B,GAAA,KAAA;AAAA;AAG1C,EAAA,IAAI,eAAe,KAAO,EAAA;AACxB,IAAA,MAAM,IAAI,KAAA,CAAM,cAAe,CAAA,KAAA,CAAM,OAAO,CAAA;AAAA;AAG9C,EAAA,MAAM,EAAE,SAAA,EAAW,YAAa,EAAA,GAAI,cAAe,CAAA,IAAA;AAEnD,EAAO,OAAA,SAAA,KAAc,qBAAqB,SAAc,KAAA,YAAA;AAC1D","file":"chunk-KF3EGMTN.js","sourcesContent":["/**\n * check-requires-mfa.ts\n *\n * このファイルはユーザーが多要素認証（MFA）を必要とするかどうかを確認するための\n * ユーティリティ関数を提供します。\n *\n * 主な機能:\n * - 現在のセッションが多要素認証を必要とするかどうかの判定\n * - 認証保証レベル（Authentication Assurance Level: AAL）の確認\n *\n * 処理の流れ:\n * 1. Supabaseクライアントから現在の認証保証レベル（AAL）を取得\n * 2. 次の認証保証レベルがAAL2（多要素認証）であり、かつ現在のレベルがそれと\n *    異なる場合、MFAが必要と判断\n *\n * 特記事項:\n * - Supabase認証のバグを回避するための一時的なワークアラウンドが含まれています\n *   （suppressGetSessionWarningフラグの設定と解除）\n * - 認証保証レベルの取得中にエラーが発生した場合は例外をスローします\n *\n * 使用例:\n * ```\n * const supabase = getSupabaseServerClient();\n * const requiresMfa = await checkRequiresMultiFactorAuthentication(supabase);\n *\n * if (requiresMfa) {\n *   // ユーザーをMFA検証ページにリダイレクト\n *   redirect('/auth/verify');\n * }\n * ```\n *\n * 注意点:\n * - この関数は通常、require-user.tsと連携して使用されます\n * - MFAが必要な場合、ユーザーは適切な検証ページにリダイレクトされるべきです\n */\nimport type { SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from './database';\n\n// checkRequiresMultiFactorAuthentication が必要とする最低限のクライアントインターフェース\nexport interface MfaCheckerClient {\n  auth: {\n    mfa: {\n      getAuthenticatorAssuranceLevel(): Promise<{\n        data: {\n          currentLevel: string | null;\n          nextLevel: string | null;\n        };\n        error: Error | null;\n      }>;\n    };\n    // suppressGetSessionWarning のための型定義 (オプショナル)\n    suppressGetSessionWarning?: boolean;\n  };\n}\n\nconst ASSURANCE_LEVEL_2 = 'aal2';\n\n/**\n * @name checkRequiresMultiFactorAuthentication\n * @description Checks if the current session requires multi-factor authentication.\n * We do it by checking that the next assurance level is AAL2 and that the current assurance level is not AAL2.\n * @param client - MfaCheckerClient 型のクライアント\n */\nexport async function checkRequiresMultiFactorAuthentication(\n  client: MfaCheckerClient\n) {\n  // Suppress the getSession warning. Remove when the issue is fixed.\n  // https://github.com/supabase/auth-js/issues/873\n  if ('suppressGetSessionWarning' in client.auth) {\n    client.auth.suppressGetSessionWarning = true;\n  }\n\n  const assuranceLevel = await client.auth.mfa.getAuthenticatorAssuranceLevel();\n\n  if ('suppressGetSessionWarning' in client.auth) {\n    client.auth.suppressGetSessionWarning = false;\n  }\n\n  if (assuranceLevel.error) {\n    throw new Error(assuranceLevel.error.message);\n  }\n\n  const { nextLevel, currentLevel } = assuranceLevel.data;\n\n  return nextLevel === ASSURANCE_LEVEL_2 && nextLevel !== currentLevel;\n}\n"]}