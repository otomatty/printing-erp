{"version":3,"sources":["../src/actions/auth/auth.ts","../src/utils/index.ts","../src/actions/enhance-action.ts","../../../node_modules/server-only/index.js","../src/routes/index.ts"],"names":["getSupabaseServerClient","verifyCaptchaToken","requireUser","redirect"],"mappings":"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","file":"index.mjs","sourcesContent":["'use server';\n\nimport { getSupabaseServerClient } from '@kit/supabase/server-client';\n\n/**\n * ProfileWithRole型の定義\n */\ntype ProfileWithRole = {\n  id: string;\n  email: string | null;\n  fullName: string | null;\n  avatarUrl: string | null;\n  createdAt: string;\n  updatedAt: string;\n  isAdmin: boolean;\n};\n\n/**\n * 現在のユーザーが管理者かどうかを確認します\n */\nexport async function checkIsAdmin(): Promise<boolean> {\n  try {\n    const supabase = await getSupabaseServerClient();\n    const { data, error } = await supabase.rpc('check_is_admin');\n\n    if (error) {\n      console.error('Error checking admin status:', error);\n      return false;\n    }\n\n    return !!data;\n  } catch (error) {\n    console.error('Unexpected error in checkIsAdmin:', error);\n    return false;\n  }\n}\n\n/**\n * 認証状態とプロフィール情報を取得します\n * @returns {Promise<{ isAuthenticated: boolean; profile: ProfileWithRole | null }>}\n */\nexport async function getAuthState() {\n  try {\n    const supabase = await getSupabaseServerClient();\n\n    // レスポンスのキャッシュを無効化\n    const response = new Response();\n    response.headers.set('Cache-Control', 'no-store');\n\n    // ユーザー情報を取得\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n      return {\n        isAuthenticated: false,\n        profile: null,\n      };\n    }\n\n    // プロフィール情報のみを取得\n    const { data: profileOnly, error: profileOnlyError } = await supabase\n      .from('user_accounts')\n      .select('*')\n      .eq('auth_user_id', user.id)\n      .single();\n\n    if (profileOnlyError || !profileOnly) {\n      return {\n        isAuthenticated: true,\n        profile: null,\n      };\n    }\n\n    // 管理者権限を確認\n    const { data: isAdmin } = await supabase\n      .schema('system')\n      .rpc('check_is_admin');\n\n    // ProfileWithRole型に変換\n    const profileWithRole: ProfileWithRole = {\n      id: profileOnly.id,\n      email: profileOnly.email ?? null,\n      fullName: profileOnly.full_name ?? null,\n      avatarUrl: profileOnly.avatar_url ?? null,\n      createdAt: profileOnly.created_at,\n      updatedAt: profileOnly.updated_at,\n      isAdmin: !!isAdmin,\n    };\n\n    return {\n      isAuthenticated: true,\n      profile: profileWithRole,\n    };\n  } catch (error) {\n    console.error('認証状態の取得に失敗しました:', error);\n    return {\n      isAuthenticated: false,\n      profile: null,\n    };\n  }\n}\n","import type { z } from 'zod';\n\nexport const zodParseFactory =\n  <T extends z.ZodTypeAny>(schema: T) =>\n  (data: unknown): z.infer<T> => {\n    try {\n      return schema.parse(data) as unknown;\n    } catch (err) {\n      console.error(err);\n\n      // handle error\n      throw new Error(`Invalid data: ${err as string}`);\n    }\n  };\n","import { redirect } from 'next/navigation';\nimport type { User } from '@supabase/supabase-js';\nimport type { ZodType, z } from 'zod';\nimport { verifyCaptchaToken } from '@kit/auth/captcha/server';\nimport {\n  requireUser,\n  type UserRequireClient,\n} from '@kit/supabase/require-user';\nimport { getSupabaseServerClient } from '@kit/supabase/server-client';\nimport { zodParseFactory } from '../utils';\n\n/**\n * @name enhanceAction\n * @description サーバーアクションを拡張し、CAPTCHA検証、スキーマ検証、認証チェックを追加します\n *\n * この関数は、Next.jsのサーバーアクションに以下の機能を追加します：\n * 1. 認証チェック: ユーザーが認証されているか確認し、未認証の場合はリダイレクト\n * 2. CAPTCHA検証: ボット対策のためのCAPTCHAトークン検証\n * 3. スキーマ検証: Zodを使用した入力データの型と値の検証\n *\n * これにより、各サーバーアクションで共通の検証ロジックを繰り返し実装する必要がなくなります。\n */\nexport function enhanceAction<\n  Args,\n  Response,\n  Config extends {\n    auth?: boolean;\n    captcha?: boolean;\n    schema?: z.ZodType<\n      Config['captcha'] extends true ? Args & { captchaToken: string } : Args,\n      z.ZodTypeDef\n    >;\n  },\n>(\n  fn: (\n    params: Config['schema'] extends ZodType ? z.infer<Config['schema']> : Args,\n    user: Config['auth'] extends false ? undefined : User\n  ) => Response | Promise<Response>,\n  config: Config\n) {\n  return async (\n    params: Config['schema'] extends ZodType ? z.infer<Config['schema']> : Args\n  ) => {\n    type UserParam = Config['auth'] extends false ? undefined : User;\n\n    // 認証が必要かどうかを設定から取得（デフォルトはtrue）\n    const requireAuth = config.auth ?? true;\n    let user: UserParam = undefined as UserParam;\n\n    // 設定でスキーマが指定されている場合、入力データを検証\n    const data = config.schema\n      ? zodParseFactory(config.schema)(params)\n      : params;\n\n    // CAPTCHAトークンの検証が必要かどうかを設定から取得（デフォルトはfalse）\n    const verifyCaptcha = config.captcha ?? false;\n\n    // CAPTCHAトークンの検証が必要な場合、トークンを検証\n    if (verifyCaptcha) {\n      const token = (data as Args & { captchaToken: string }).captchaToken;\n\n      // CAPTCHAトークンを検証。トークンが無効な場合はエラーをスロー\n      await verifyCaptchaToken(token);\n    }\n\n    // 認証が必要な場合、ユーザーが認証されているか確認\n    if (requireAuth) {\n      try {\n        // Supabaseクライアントを使用してユーザー認証情報を取得\n        const auth = await requireUser(\n          getSupabaseServerClient() as unknown as UserRequireClient\n        );\n\n        // ユーザーが認証されていない場合、指定されたURLにリダイレクト\n        if (!auth.data) {\n          redirect(auth.redirectTo);\n        }\n\n        // 認証済みの場合、ユーザー情報を user 変数に格納\n        user = auth.data as unknown as UserParam;\n      } catch (error) {\n        // エラー処理...\n      }\n    }\n\n    // すべての検証が成功したら、元の関数を実行して結果を返す\n    return fn(data, user);\n  };\n}\n","throw new Error(\n  \"This module cannot be imported from a Client Component module. \" +\n    \"It should only be used from a Server Component.\"\n);\n","import 'server-only';\n\nimport { redirect } from 'next/navigation';\nimport type { NextRequest, NextResponse } from 'next/server';\n\nimport type { User, SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from '@kit/supabase/database';\n\nimport type { z } from 'zod';\n\nimport { verifyCaptchaToken } from '@kit/auth/captcha/server';\nimport { requireUser } from '@kit/supabase/require-user';\nimport { getSupabaseServerClient } from '@kit/supabase/server-client';\n\nimport { zodParseFactory } from '../utils';\n\ninterface Config<Schema> {\n  auth?: boolean;\n  captcha?: boolean;\n  schema?: Schema;\n}\n\ninterface HandlerParams<\n  Schema extends z.ZodType | undefined,\n  RequireAuth extends boolean | undefined,\n> {\n  request: NextRequest;\n  user: RequireAuth extends false ? undefined : User;\n  body: Schema extends z.ZodType ? z.infer<Schema> : undefined;\n  params: Record<string, string>;\n}\n\n/**\n * 拡張されたルートハンドラ関数。\n *\n * この関数はリクエストとパラメータオブジェクトを引数として受け取り、ルートハンドラ関数を返します。\n * 返されたルートハンドラ関数は、HTTPリクエストを処理し、提供されたパラメータに基づいて\n * 追加の機能拡張（認証、CAPTCHA検証、スキーマ検証など）を適用します。\n *\n * 主な機能:\n * 1. 認証チェック: ユーザーが認証されているか確認し、未認証の場合はリダイレクト\n * 2. CAPTCHA検証: ヘッダーからCAPTCHAトークンを取得して検証\n * 3. スキーマ検証: Zodを使用したリクエストボディの検証\n * 4. 型安全性: TypeScriptの型推論を活用した型安全なハンドラ\n *\n * 使用例:\n * export const POST = enhanceRouteHandler(\n *   ({ request, body, user }) => {\n *     return new Response(`こんにちは、${body.name}さん!`);\n *   },\n *   {\n *     schema: z.object({\n *       name: z.string(),\n *     }),\n *   },\n * );\n *\n */\nexport const enhanceRouteHandler = <\n  Body,\n  Params extends Config<z.ZodType<Body, z.ZodTypeDef>>,\n>(\n  // ルートハンドラ関数\n  handler:\n    | ((\n        params: HandlerParams<Params['schema'], Params['auth']>\n      ) => NextResponse | Response)\n    | ((\n        params: HandlerParams<Params['schema'], Params['auth']>\n      ) => Promise<NextResponse | Response>),\n  // パラメータオブジェクト\n  params?: Params\n) => {\n  /**\n   * ルートハンドラ関数。\n   *\n   * この関数はリクエストオブジェクトを引数として受け取り、レスポンスオブジェクトを返します。\n   * Next.jsのAPIルートで使用されるメインの処理関数です。\n   */\n  return async function routeHandler(\n    request: NextRequest,\n    routeParams: {\n      params: Promise<Record<string, string>>;\n    }\n  ) {\n    type UserParam = Params['auth'] extends false ? undefined : User;\n\n    let user: UserParam = undefined as UserParam;\n\n    // CAPTCHAトークンを検証すべきかどうかを設定から取得（デフォルトはfalse）\n    const shouldVerifyCaptcha = params?.captcha ?? false;\n\n    // CAPTCHAトークンの検証が必要かつ設定されている場合、トークンを検証\n    if (shouldVerifyCaptcha) {\n      const token = captchaTokenGetter(request);\n\n      // CAPTCHAトークンが提供されていない場合、400エラーレスポンスを返す\n      if (token) {\n        await verifyCaptchaToken(token);\n      } else {\n        return new Response('CAPTCHAトークンが必要です', { status: 400 });\n      }\n    }\n\n    // Supabaseクライアントを初期化\n    // @ts-ignore\n    const client = getSupabaseServerClient();\n\n    // 認証が必要かどうかを設定から取得（デフォルトはtrue）\n    const shouldVerifyAuth = params?.auth ?? true;\n\n    // 認証が必要な場合、ユーザーが認証されているか確認\n    if (shouldVerifyAuth) {\n      // 認証済みユーザーを取得\n      const auth = await requireUser(client);\n\n      // ユーザーが認証されていない場合、指定されたURLにリダイレクト\n      if (auth.error) {\n        return redirect(auth.redirectTo);\n      }\n\n      user = auth.data as UserParam;\n    }\n\n    let body: Params['schema'] extends z.ZodType\n      ? z.infer<Params['schema']>\n      : undefined = undefined;\n\n    // スキーマが指定されている場合、リクエストボディを検証\n    if (params?.schema) {\n      // リクエストをクローンしてボディを読み取り\n      // ハンドラに安全に渡せるようにする\n      const json = await request.clone().json();\n\n      // Zodスキーマを使用してリクエストボディを検証\n      body = zodParseFactory(params.schema)(\n        json\n      ) as Params['schema'] extends z.ZodType\n        ? z.infer<Params['schema']>\n        : never;\n    }\n\n    // すべての検証が成功したら、ハンドラ関数を実行して結果を返す\n    return handler({\n      request,\n      body,\n      user,\n      params: await routeParams.params,\n    });\n  };\n};\n\n/**\n * リクエストヘッダーからCAPTCHAトークンを取得します。\n * @param request NextRequestオブジェクト\n * @returns CAPTCHAトークン文字列またはnull\n */\nfunction captchaTokenGetter(request: NextRequest) {\n  return request.headers.get('x-captcha-token');\n}\n"]}