---
title: 一時停止と再開
description: ワークフローの一時停止と再開の実装
order: 5
updated: 2025-04-10
---

# ワークフローの一時停止と再開

複雑なワークフローでは、外部からの入力やリソースを待つために実行を一時停止する必要があることがよくあります。

Mastraの一時停止と再開機能を使用すると、任意のステップでワークフロー実行を一時停止し、ワークフローのスナップショットをストレージに保存し、準備ができたら保存されたスナップショットから実行を再開することができます。

このプロセス全体はMastraによって自動的に管理されます。

設定や手動のステップは必要ありません。

ワークフローのスナップショットをストレージ（デフォルトではLibSQL）に保存することで、セッション、デプロイメント、サーバーの再起動全体で永続的にワークフロー状態が保持されます。

この永続性は、外部入力やリソースを待つ間に数分、数時間、あるいは数日間一時停止したままになる可能性のあるワークフローにとって非常に重要です。

## 一時停止/再開を使用するタイミング

ワークフローを一時停止する一般的なシナリオには以下があります：

- 人間の承認や入力を待つ
- 外部APIリソースが利用可能になるまで一時停止する
- 後のステップに必要な追加データを収集する
- 高コストな操作のレート制限やスロットリング
- 外部トリガーによるイベント駆動プロセスの処理

## 基本的な一時停止の例

以下は、値が低すぎる場合に一時停止し、より高い値が与えられたときに再開する簡単なワークフローです：

```javascript
const stepTwo = new Step({
  id: "stepTwo",
  outputSchema: z.object({
    incrementedValue: z.number(),
  }),
  execute: async ({ context, suspend }) => {
    if (context.steps.stepOne.status !== "success") {
      return { incrementedValue: 0 };
    }
 
    const currentValue = context.steps.stepOne.output.doubledValue;
 
    if (currentValue < 100) {
      await suspend();
      return { incrementedValue: 0 };
    }
    return { incrementedValue: currentValue + 1 };
  },
});
```

## Async/Awaitベースのフロー

Mastraの一時停止と再開メカニズムは、一時停止ポイントを持つ複雑なワークフローを直感的に実装できるasync/awaitパターンを使用しています。
コード構造は実行フローを自然に反映します。

## 仕組み

- ステップの実行関数は、パラメータにsuspend関数を受け取ります
- `await suspend()`で呼び出されると、ワークフローはその時点で一時停止します
- ワークフロー状態が永続化されます
- 後で、適切なパラメータを指定して`workflow.resume()`を呼び出すことでワークフローを再開できます
- 実行は`suspend()`呼び出しの後のポイントから継続します

## 複数の一時停止ポイントを持つ例

以下は、複数のステップが一時停止できるワークフローの例です：

```javascript
// 一時停止機能を持つステップを定義
const promptAgentStep = new Step({
  id: "promptAgent",
  execute: async ({ context, suspend }) => {
    // 一時停止が必要かどうかを判断する条件
    if (needHumanInput) {
      // オプションで一時停止状態と共に保存されるペイロードデータを渡す
      await suspend({ requestReason: "Need human input for prompt" });
      // suspend()の後のコードはステップが再開されたときに実行される
      return { modelOutput: context.userInput };
    }
    return { modelOutput: "AI generated output" };
  },
  outputSchema: z.object({ modelOutput: z.string() }),
});
 
const improveResponseStep = new Step({
  id: "improveResponse",
  execute: async ({ context, suspend }) => {
    // 一時停止のための別の条件
    if (needFurtherRefinement) {
      await suspend();
      return { improvedOutput: context.refinedOutput };
    }
    return { improvedOutput: "Improved output" };
  },
  outputSchema: z.object({ improvedOutput: z.string() }),
});
 
// ワークフローを構築
const workflow = new Workflow({
  name: "multi-suspend-workflow",
  triggerSchema: z.object({ input: z.string() }),
});
 
workflow
  .step(getUserInput)
  .then(promptAgentStep)
  .then(evaluateTone)
  .then(improveResponseStep)
  .then(evaluateImproved)
  .commit();
 
// ワークフローをMastraに登録
export const mastra = new Mastra({
  workflows: { workflow },
});
// ワークフローを取得して実行を作成
const wf = mastra.getWorkflow("multi-suspend-workflow");
const run = wf.createRun();
 
// ワークフローを開始
const initialResult = await run.start({
  triggerData: { input: "initial input" },
});
 
let promptAgentStepResult = initialResult.activePaths.get("promptAgent");
let promptAgentResumeResult = undefined;
 
// ステップが一時停止しているかチェック
if (promptAgentStepResult?.status === "suspended") {
  console.log("Workflow suspended at promptAgent step");
 
  // 新しいコンテキストでワークフローを再開
  const resumeResult = await run.resume({
    stepId: "promptAgent",
    context: { userInput: "Human provided input" },
  });
 
  promptAgentResumeResult = resumeResult;
}
 
const improveResponseStepResult =
  promptAgentResumeResult?.activePaths.get("improveResponse");
 
if (improveResponseStepResult?.status === "suspended") {
  console.log("Workflow suspended at improveResponse step");
 
  // 異なるコンテキストで再度再開
  const finalResult = await run.resume({
    stepId: "improveResponse",
    context: { refinedOutput: "Human refined output" },
  });
 
  console.log("Workflow completed:", finalResult?.results);
}
```

## イベントベースの一時停止と再開

手動でステップを一時停止する以外に、Mastraは`afterEvent`メソッドを通じてイベントベースの一時停止を提供します。これにより、ワークフローは自動的に一時停止し、特定のイベントが発生するのを待ってから続行することができます。

### afterEventとresumeWithEventの使用

`afterEvent`メソッドは、特定のイベントが発生するのを待つワークフローに自動的に一時停止ポイントを作成します。イベントが発生したら、`resumeWithEvent`を使用してイベントデータとともにワークフローを続行できます。

仕組みは以下の通りです：

1. ワークフロー設定でイベントを定義する
2. `afterEvent`を使用してそのイベントを待つ一時停止ポイントを作成する
3. イベントが発生したら、イベント名とデータを指定して`resumeWithEvent`を呼び出す

```javascript
// ステップを定義
const getUserInput = new Step({
  id: "getUserInput",
  execute: async () => ({ userInput: "initial input" }),
  outputSchema: z.object({ userInput: z.string() }),
});
 
const processApproval = new Step({
  id: "processApproval",
  execute: async ({ context }) => {
    // コンテキストからイベントデータにアクセス
    const approvalData = context.inputData?.resumedEvent;
    return {
      approved: approvalData?.approved,
      approvedBy: approvalData?.approverName,
    };
  },
  outputSchema: z.object({
    approved: z.boolean(),
    approvedBy: z.string(),
  }),
});
 
// イベント定義を含むワークフローを作成
const approvalWorkflow = new Workflow({
  name: "approval-workflow",
  triggerSchema: z.object({ requestId: z.string() }),
  events: {
    approvalReceived: {
      schema: z.object({
        approved: z.boolean(),
        approverName: z.string(),
      }),
    },
  },
});
 
// イベントベースの一時停止を使用してワークフローを構築
approvalWorkflow
  .step(getUserInput)
  .afterEvent("approvalReceived") // ワークフローはここで自動的に一時停止する
  .step(processApproval) // このステップはイベントを受信した後に実行される
  .commit();
// ワークフローを取得
const workflow = mastra.getWorkflow("approval-workflow");
const run = workflow.createRun();
 
// ワークフローを開始
const initialResult = await run.start({
  triggerData: { requestId: "request-123" },
});
 
console.log("Workflow started, waiting for approval event");
console.log(initialResult.results);
// 出力はイベントステップで一時停止していることを示します：
// {
//   getUserInput: { status: 'success', output: { userInput: 'initial input' } },
//   __approvalReceived_event: { status: 'suspended' }
// }
 
// 後で、承認イベントが発生したとき：
const resumeResult = await run.resumeWithEvent("approvalReceived", {
  approved: true,
  approverName: "Jane Doe",
});
 
console.log("Workflow resumed with event data:", resumeResult.results);
// 出力は完了したワークフローを示します：
// {
//   getUserInput: { status: 'success', output: { userInput: 'initial input' } },
//   __approvalReceived_event: { status: 'success', output: { executed: true, resumedEvent: { approved: true, approverName: 'Jane Doe' } } },
//   processApproval: { status: 'success', output: { approved: true, approvedBy: 'Jane Doe' } }
// }
```

## イベントベースのワークフローに関する重要なポイント

- `suspend()`関数はオプションでペイロードオブジェクトを受け取ることができ、このオブジェクトは一時停止状態と共に保存されます
- `await suspend()`呼び出しの後のコードは、ステップが再開されるまで実行されません
- ステップが一時停止すると、そのステータスはワークフロー結果で「suspended」になります
- 再開されると、ステップのステータスは完了すると「suspended」から「success」に変わります
- `resume()`メソッドは、どの一時停止ステップを再開するかを識別するために`stepId`を必要とします
- 再開時に新しいコンテキストデータを提供でき、これは既存のステップ結果とマージされます
- イベントはスキーマを持つワークフロー設定で定義する必要があります
- `afterEvent`メソッドは、イベントを待つ特別な一時停止ステップを作成します
- イベントステップは自動的に`__eventName_event`（例：`__approvalReceived_event`）という名前になります
- イベントデータを提供してワークフローを続行するには`resumeWithEvent`を使用します
- イベントデータはそのイベントに定義されたスキーマに対して検証されます
- イベントデータは`inputData.resumedEvent`としてコンテキストで利用できます

## 一時停止と再開のためのストレージ

ワークフローが`await suspend()`を使用して一時停止されると、Mastraは自動的にワークフロー全体の状態をストレージに永続化します。これは、長期間一時停止したままになる可能性のあるワークフローにとって不可欠で、アプリケーションの再起動やサーバーインスタンス間で状態が保持されることを保証します。

### デフォルトストレージ: LibSQL

デフォルトでは、Mastraはストレージエンジンとして LibSQL を使用します：

```javascript
import { Mastra } from "@mastra/core/mastra";
import { DefaultStorage } from "@mastra/core/storage/libsql";
 
const mastra = new Mastra({
  storage: new DefaultStorage({
    config: {
      url: "file:storage.db", // 開発用のローカルファイルベースのデータベース
      // 本番環境では、永続的なURLを使用します：
      // url: process.env.DATABASE_URL,
      // authToken: process.env.DATABASE_AUTH_TOKEN, // 認証接続用のオプション
    },
  }),
});
```

LibSQLストレージは異なるモードで設定できます：

- インメモリデータベース（テスト用）: `:memory:`
- ファイルベースのデータベース（開発用）: `file:storage.db`
- リモートデータベース（本番用）: `libsql://your-database.turso.io`のようなURL

### 代替ストレージオプション

#### Upstash（Redis互換）

サーバーレスアプリケーションやRedisが好ましい環境向け：

```javascript
npm install @mastra/upstash
import { Mastra } from "@mastra/core/mastra";
import { UpstashStore } from "@mastra/upstash";
 
const mastra = new Mastra({
  storage: new UpstashStore({
    url: process.env.UPSTASH_URL,
    token: process.env.UPSTASH_TOKEN,
  }),
});
```

### ストレージに関する考慮事項

- すべてのストレージオプションは一時停止と再開機能を同様にサポートします
- ワークフロー状態は一時停止時に自動的にシリアライズされて保存されます
- ストレージで一時停止/再開を機能させるための追加設定は必要ありません
- インフラ、スケーリングのニーズ、既存の技術スタックに基づいてストレージオプションを選択してください

## 監視と再開

一時停止したワークフローを処理するには、`watch`メソッドを使用して実行ごとのワークフロー状態を監視し、`resume`を使用して実行を継続します：

```javascript
import { mastra } from "./index";
 
// ワークフローを取得
const myWorkflow = mastra.getWorkflow("myWorkflow");
const { start, watch, resume } = myWorkflow.createRun();
 
// 実行前にワークフローの監視を開始
watch(async ({ activePaths }) => {
  const isStepTwoSuspended = activePaths.get("stepTwo")?.status === "suspended";
  if (isStepTwoSuspended) {
    console.log("Workflow suspended, resuming with new value");
 
    // 新しいコンテキストでワークフローを再開
    await resume({
      stepId: "stepTwo",
      context: { secondValue: 100 },
    });
  }
});
 
// ワークフロー実行を開始
await start({ triggerData: { inputValue: 45 } });
```

### イベントベースのワークフローの監視と再開

同じ監視パターンをイベントベースのワークフローでも使用できます：

```javascript
const { start, watch, resumeWithEvent } = workflow.createRun();
 
// 一時停止したイベントステップを監視
watch(async ({ activePaths }) => {
  const isApprovalReceivedSuspended =
    activePaths.get("__approvalReceived_event")?.status === "suspended";
  if (isApprovalReceivedSuspended) {
    console.log("Workflow waiting for approval event");
 
    // 実際のシナリオでは、実際のイベントが発生するのを待ちます
    // 例えば、これはウェブフックやユーザーインタラクションによってトリガーされる可能性があります
    setTimeout(async () => {
      await resumeWithEvent("approvalReceived", {
        approved: true,
        approverName: "Auto Approver",
      });
    }, 5000); // 5秒後にイベントをシミュレート
  }
});
 
// ワークフローを開始
await start({ triggerData: { requestId: "auto-123" } });
```

## 詳細を読む

一時停止と再開がバックグラウンドでどのように機能するかについての深い理解のために：

- [Mastraワークフローのスナップショットの理解](https://docs.mastra.dev/docs/workflows/control-flow) - 一時停止と再開機能を支えるスナップショットメカニズムについて学ぶ
- [ステップ設定ガイド](https://docs.mastra.dev/docs/workflows/control-flow) - ワークフローでのステップの設定についてさらに学ぶ
- [制御フローガイド](https://docs.mastra.dev/docs/workflows/control-flow) - 高度なワークフロー制御パターン
- [イベント駆動ワークフロー](https://docs.mastra.dev/docs/workflows/event-driven) - イベントベースのワークフローの詳細リファレンス

## 関連リソース

- 完全な動作例については「[一時停止と再開の例](../../mastra-examples/workflows/suspend-and-resume)」を参照してください
- 一時停止/再開APIの詳細については「[ステップクラスリファレンス](https://docs.mastra.dev/docs/workflows/control-flow)」を確認してください
- 一時停止したワークフローの監視については「[ワークフロー可観測性](https://docs.mastra.dev/docs/workflows/observability)」をレビューしてください 