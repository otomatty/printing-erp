---
title: 動的ワークフロー
description: 動的に変化するワークフローの実装方法
order: 6
updated: 2025-04-10
---

# 動的ワークフロー

このガイドでは、ワークフローステップ内で動的ワークフローを作成する方法を紹介します。この高度なパターンを使用すると、実行時の条件に基づいてワークフローをその場で作成して実行することができます。

## 概要

動的ワークフローは、実行時データに基づいてワークフローを作成する必要がある場合に役立ちます。

## 実装

動的ワークフローを作成するための鍵は、ステップの`execute`関数内からMastraインスタンスにアクセスし、それを使用して新しいワークフローを作成して実行することです。

```javascript
import { Mastra, Step, Workflow } from '@mastra/core';
import { z } from 'zod';
 
const isMastra = (mastra: any): mastra is Mastra => {
  return mastra && typeof mastra === 'object' && mastra instanceof Mastra;
};
 
// 動的ワークフローを作成して実行するステップ
const createDynamicWorkflow = new Step({
  id: 'createDynamicWorkflow',
  outputSchema: z.object({
    dynamicWorkflowResult: z.any(),
  }),
  execute: async ({ context, mastra }) => {
    if (!mastra) {
      throw new Error('Mastra instance not available');
    }
 
    if (!isMastra(mastra)) {
      throw new Error('Invalid Mastra instance');
    }
 
    const inputData = context.triggerData.inputData;
 
    // 新しい動的ワークフローを作成
    const dynamicWorkflow = new Workflow({
      name: 'dynamic-workflow',
      mastra, // Mastraインスタンスを新しいワークフローに渡す
      triggerSchema: z.object({
        dynamicInput: z.string(),
      }),
    });
 
    // 動的ワークフロー用のステップを定義
    const dynamicStep = new Step({
      id: 'dynamicStep',
      execute: async ({ context }) => {
        const dynamicInput = context.triggerData.dynamicInput;
        return {
          processedValue: `Processed: ${dynamicInput}`,
        };
      },
    });
 
    // 動的ワークフローを構築してコミット
    dynamicWorkflow.step(dynamicStep).commit();
 
    // 実行を作成し、動的ワークフローを実行
    const run = dynamicWorkflow.createRun();
    const result = await run.start({
      triggerData: {
        dynamicInput: inputData,
      },
    });
 
    let dynamicWorkflowResult;
 
    if (result.results['dynamicStep']?.status === 'success') {
      dynamicWorkflowResult = result.results['dynamicStep']?.output.processedValue;
    } else {
      throw new Error('Dynamic workflow failed');
    }
 
    // 動的ワークフローからの結果を返す
    return {
      dynamicWorkflowResult,
    };
  },
});
 
// 動的ワークフロー作成機能を使用するメインワークフロー
const mainWorkflow = new Workflow({
  name: 'main-workflow',
  triggerSchema: z.object({
    inputData: z.string(),
  }),
  mastra: new Mastra(),
});
 
mainWorkflow.step(createDynamicWorkflow).commit();
 
// ワークフローをMastraに登録
export const mastra = new Mastra({
  workflows: { mainWorkflow },
});
 
const run = mainWorkflow.createRun();
const result = await run.start({
  triggerData: {
    inputData: 'test',
  },
});
```

## 高度な例：ワークフローファクトリー

入力パラメータに基づいて異なるワークフローを生成するワークフローファクトリーを作成できます：

```javascript
 
const isMastra = (mastra: any): mastra is Mastra => {
  return mastra && typeof mastra === 'object' && mastra instanceof Mastra;
};
 
const workflowFactory = new Step({
  id: 'workflowFactory',
  inputSchema: z.object({
    workflowType: z.enum(['simple', 'complex']),
    inputData: z.string(),
  }),
  outputSchema: z.object({
    result: z.any(),
  }),
  execute: async ({ context, mastra }) => {
    if (!mastra) {
      throw new Error('Mastra instance not available');
    }
 
    if (!isMastra(mastra)) {
      throw new Error('Invalid Mastra instance');
    }
 
    // タイプに基づいて新しい動的ワークフローを作成
    const dynamicWorkflow = new Workflow({
      name: `dynamic-${context.workflowType}-workflow`,
      mastra,
      triggerSchema: z.object({
        input: z.string(),
      }),
    });
 
    if (context.workflowType === 'simple') {
      // 単一ステップのシンプルなワークフロー
      const simpleStep = new Step({
        id: 'simpleStep',
        execute: async ({ context }) => {
          return {
            result: `Simple processing: ${context.triggerData.input}`,
          };
        },
      });
 
      dynamicWorkflow.step(simpleStep).commit();
    } else {
      // 複数ステップの複雑なワークフロー
      const step1 = new Step({
        id: 'step1',
        outputSchema: z.object({
          intermediateResult: z.string(),
        }),
        execute: async ({ context }) => {
          return {
            intermediateResult: `First processing: ${context.triggerData.input}`,
          };
        },
      });
 
      const step2 = new Step({
        id: 'step2',
        execute: async ({ context }) => {
          const intermediate = context.getStepResult(step1).intermediateResult;
          return {
            finalResult: `Second processing: ${intermediate}`,
          };
        },
      });
 
      dynamicWorkflow.step(step1).then(step2).commit();
    }
 
    // 動的ワークフローを実行
    const run = dynamicWorkflow.createRun();
    const result = await run.start({
      triggerData: {
        input: context.inputData,
      },
    });
 
    // ワークフロータイプに基づいて適切な結果を返す
    if (context.workflowType === 'simple') {
      return {
        // @ts-ignore
        result: result.results['simpleStep']?.output,
      };
    } else {
      return {
        // @ts-ignore
        result: result.results['step2']?.output,
      };
    }
  },
});
```

## 重要な考慮事項

- **Mastraインスタンス**: `execute`関数内の`mastra`パラメータは、動的ワークフローの作成に不可欠なMastraインスタンスへのアクセスを提供します。

- **エラー処理**: 動的ワークフローを作成する前に、常にMastraインスタンスが利用可能かどうかを確認してください。

- **リソース管理**: 動的ワークフローはリソースを消費するため、単一実行内で多すぎるワークフローを作成しないよう注意してください。

- **ワークフローライフサイクル**: 動的ワークフローはメインMastraインスタンスに自動的に登録されません。明示的に登録しない限り、ステップ実行期間中にのみ存在します。

- **デバッグ**: 動的ワークフローのデバッグは難しい場合があります。動的ワークフローの作成と実行を追跡するために、詳細なロギングを追加することを検討してください。

## ユースケース

- **条件付きワークフロー選択**: 入力データに基づいて異なるワークフローパターンを選択
- **パラメータ化されたワークフロー**: 動的な設定でワークフローを作成
- **ワークフローテンプレート**: テンプレートを使用して特殊なワークフローを生成
- **マルチテナントアプリケーション**: 異なるテナント用に分離されたワークフローを作成

## 結論

動的ワークフローは、柔軟で適応性のあるワークフローシステムを作成するための強力な方法を提供します。ステップ実行内でMastraインスタンスを活用することで、実行時の条件や要件に応じたワークフローを作成できます。