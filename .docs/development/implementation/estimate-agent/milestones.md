# プロジェクトマイルストーン: 業務システム自動見積もりAIエージェント

**文書ステータス:** ドラフト (担当: 私よ！アンタの計画まで立ててあげてるの！)

**参照ドキュメント:**
*   [PRD](./PRD.md)
*   [データベース設計](./database_design.md)
*   [見積もりロジックとワークフロー設計](./estimation_logic.md)
*   [Mastra公式ドキュメント]()

## 概要

この文書は、「業務システム自動見積もりAIエージェント」開発プロジェクトのマイルストーンを定義する。
PRDに基づき、開発フェーズを分割し、各フェーズでの目標と主要タスクを明確にする。

## フェーズ1: 基盤構築と基本データ準備 (完了済み)

**目標:** プロジェクトの初期設定、データベースの基本構造定義、およびRAGの基礎となるサンプルデータの準備。

**主要タスク:**
*   ✅ **プロジェクト初期化:** Mastraプロジェクト (`estimate-agent`) を `apps` ディレクトリに作成。
*   ✅ **要求定義 (PRD):** 基本的な機能要件、非機能要件、Mastra活用方針を定義 (`PRD.md`)。
*   ✅ **データベース設計:** 主要テーブル（認証なし対応含む）、RLSポリシー、基本関数を定義 (`database_design.md`)。
*   ✅ **スキーマ整理:** スキーマ名を `public` から `estimate_agent` に統一。
*   ✅ **サンプルデータ作成:** 基本的なシステムカテゴリ、質問テンプレート、プロジェクトテンプレートのSQLデータを作成 (`sample_data.sql`)。
*   ✅ **Supabaseマイグレーション:**
    *   ✅ `pgvector` 拡張機能の有効化。
    *   ✅ `estimate_agent` スキーマ、全テーブル、RLSポリシー、関数のSupabaseへの適用。
    *   ✅ サンプルデータのSupabaseへの投入。

**完了時点での成果物:**
*   初期化済み Mastra プロジェクト
*   PRD.md, database_design.md, sample_data.sql, estimation_logic.md
*   Supabase上に構築された `estimate_agent` スキーマとテーブル、投入済みサンプルデータ

## フェーズ2: RAG実装と見積もりコアロジック開発

**目標:** 過去データ(プロジェクトテンプレート)を活用したRAG機能の実装と、基本的な見積もりワークフロー(工数ベース)の構築。
**使用モデル:** Gemini (`gemini-2.0-flash`, `gemini-embedding-exp-03-07`)

**主要タスク:**
*   ✅ **ベクトルEmbedding生成 (Gemini):**
    *   ✅ `project_templates` の `features` や `description` から **Gemini Embedding (`gemini-embedding-exp-03-07`)** を使用してEmbeddingを生成し、`content_embedding` 列に格納するスクリプトを作成・実行 (**3072次元から1536次元に切り出す処理を含む**)。
*   ✅ **RAG検索ロジック実装:**
    *   ✅ ユーザー入力 (初期要件) に基づいて類似プロジェクトをベクトル検索する機能を実装。(`src/rag/vector-search.ts` の `findSimilarProjects` 関数)
*   ✅ **見積もりワークフロー実装 (Mastra Workflow):** [見積もりロジックとワークフロー設計](./estimation_logic.md)を参照
    *   ✅ **Trigger:** `userInput` と `projectType` を受け取るように変更。
    *   ✅ **Step 1: 要件分析 (`analyzeRequirements`):** ユーザー入力受け取り、類似プロジェクト検索 (RAG活用)。
    *   ✅ **Step 2: 機能リスト生成 (`generateFeatures`):** `projectType` に応じてペルソナを切り替え、類似プロジェクトの機能を参考に、カテゴリ分類・絞り込み・概要付きで機能候補をJSON形式で生成 (**Gemini** `gemini-2.0-flash` 使用)。
    *   ✅ **Step 2.5: 機能必要性判断 (`assessFeatureNecessity`):** 既存の必要性判断プロンプトを使用し、各機能候補の必要性を評価するステップを追加 (**Gemini** `gemini-2.0-flash` 使用)。
    *   ✅ **Step 3: 工数見積もり (`estimateEffort`):** **必要性に関わらず全ての機能候補**に対して工数を予測。**現状、Embeddingの問題によりRAGは機能しておらず、LLM(`gemini-2.0-flash`)による推論＋フォールバックで対応。結果に必要性フラグ (`isNecessary`) を付与。**
    *   ✅ **Step 4: コスト算出 (`calculateCost`):** 予測工数 × 時間単価 で**必要コスト、任意コスト、総コスト**を計算。各機能の内訳にも必要性フラグを追加。

**このフェーズの完了条件:**
*   ユーザーが**システムタイプ**とシステム概要を入力すると、RAGによって類似プロジェクトが検索され、**システムタイプに応じた**必要性が判断された機能リストが生成され、**各機能の工数と必要性フラグ**が付与されること。最終的に、**必要コスト、任意コスト、総コスト**が、それぞれの内訳と共に提示されること。

## フェーズ3: 一括質問と見積もり調整

**目標:** AIによる追加質問(一括形式)の実装と、ユーザーフィードバックによる見積もり調整機能の実現。

**主要タスク:**
*   ✅ **追加質問生成ロジック (一括):**
    *   ✅ 初期要件と特定されたシステムカテゴリ (`project_categories`) に基づき、関連する `question_templates` を選択し、質問リストを生成する**ワークフローステップ (`generateFollowUpQuestions`)** を実装。
    *   □ Agent または UI が生成された質問リストをユーザーに提示し、回答を受け付ける。
    *   □ ユーザーの回答を `estimate_questions` / `temporary_estimate_questions` に一括で保存。
*   □ **見積もり調整機能:**
    *   □ ユーザーがAI提示の機能リスト (`estimate_items` / `temporary_estimate_items`) を選択・編集できるようにする。
    *   □ ユーザーの回答や選択に基づき、工数見積もりを再計算するロジック。
*   □ **Mastra Agent 機能拡張:**
    *   □ 一括質問の提示と回答受付を処理。
    *   □ ユーザーによる機能選択・調整のインタラクションを処理。
*   □ **プロンプトチューニング:**
    *   □ 質問生成、機能洗い出し、工数見積もりの精度向上のためのプロンプト調整。

**このフェーズの完了条件:**
*   AIがユーザーの入力に応じて適切な追加質問リストを一括で提示し、その回答や機能選択を反映して見積もり結果が調整されること。

## フェーズ4: ビジネス価値分析と出力機能

**目標:** PRD記載のビジネス価値分析機能の実装と、見積書および分析レポートの出力機能の実現。

**主要タスク:**
*   □ **ビジネス分析ロジック実装:**
    *   □ コスト最適化分析ロジックの実装。
    *   □ ROI分析・投資回収期間予測ロジックの実装 (`industry_benchmarks` RAG活用)。
    *   □ 業務効率化予測ロジックの実装。
    *   □ 拡張性分析ロジックの実装。
    *   □ 分析結果を `business_analyses` テーブルに保存。
*   □ **業界ベンチマークデータ整備:**
    *   □ `industry_benchmarks` テーブルにベンチマークデータを投入。
    *   □ 必要に応じてEmbedding生成。
*   □ **出力機能実装:**
    *   □ 見積書PDF生成機能（機能一覧、コスト、前提条件など）。URLを `estimates` / `temporary_estimates` に保存。
    *   □ ビジネス分析レポート生成機能（PDF/Excel）。URLを `business_analysis_reports` に保存。
*   □ **UI/UX改善 (必要に応じて):**
    *   □ 分析結果をグラフ等で分かりやすく表示。

**このフェーズの完了条件:**
*   算出された見積もりに対してビジネス価値分析が行われ、結果がレポートとして出力できること。

## フェーズ5: テスト、デプロイ、改善サイクル

**目標:** システム全体のテスト、デプロイ準備、および継続的な改善サイクルの確立。

**主要タスク:**
*   □ **統合テスト:**
    *   □ エンドツーエンドでのワークフロー動作確認。
    *   □ 見積もり精度テスト（複数のシナリオで実施）。
    *   □ RLSポリシーテスト。
*   □ **ドキュメント整備:**
    *   □ README更新（セットアップ方法、使用方法）。
    *   □ 必要に応じて、コードコメントや設計ドキュメントの更新。
*   □ **デプロイ準備:**
    *   □ 環境変数設定。
    *   □ デプロイ手順の確立。
*   □ **フィードバックループ構築:**
    *   □ 実際の利用データ（見積もり結果と実際のプロジェクト結果）を収集・分析する仕組み。
    *   □ 定期的な精度評価とモデル・ロジック改善プロセス。

**このフェーズの完了条件:**
*   システムが安定稼働し、ユーザーが利用可能な状態になること。
*   継続的な改善プロセスが確立されること。

---

**注意:** これはあくまで現時点での計画よ。進捗や課題に応じて見直す必要があるかもしれないから、そのつもりでいなさい。 